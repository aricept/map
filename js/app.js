var Flight=function(e){var t=this;t.callsign=ko.observable(e.callsign),t.carrier=ko.observable(e.carrier),t.planeImg=ko.observable(e.planeImg),t.heading=ko.observable(e.heading),t.depPort=ko.observable(e.depPort),t.arrPort=ko.observable(e.arrPort),t.img=ko.observable(e.img),t.icon=ko.observable(e.icon),t.planeLoaded=ko.observable(!0),t.imgLoaded=ko.observable(!0),t.flight=ko.computed(function(){return t.callsign().slice(3)}),t.airline=ko.computed(function(){return e.airline?e.airline:t.callsign().slice(0,3)}),t.departed=ko.computed(function(){if(t.depPort().city){var e=t.depPort().city;return t.depPort().stateCode?e+", "+t.depPort().stateCode:e+", "+t.depPort().countryName}return t.depPort()}),t.depTime=ko.computed(function(){if(e.depTime){var t=e.depTime.split("T"),r=t[1].split(":");return parseInt(r[0])>12?parseInt(r[0])-12+":"+r[1]+" PM":12===parseInt(r[0])?r[0]+":"+r[1]+" PM":r[0]+":"+r[1]+" AM"}return"Unknown Time"}),t.arriving=ko.computed(function(){if(t.arrPort().city){var e=t.arrPort().city;return t.arrPort().stateCode?e+", "+t.arrPort().stateCode:e+", "+t.arrPort().countryName}return t.arrPort()}),t.arrTime=ko.computed(function(){if(e.arrTime){var t=e.arrTime.split("T"),r=t[1].split(":");return parseInt(r[0])>12?parseInt(r[0])-12+":"+r[1]+" PM":12===parseInt(r[0])?r[0]+":"+r[1]+" PM":r[0]+":"+r[1]+" AM"}return"Unknown Time"}),t.name=ko.computed(function(){return e.name?e.name:"Flight "+t.flight()}),t.positions=ko.computed(function(){return e.posData(e.positions)}),t.marker=ko.computed(function(){return e.marker(t)}),t.plane=ko.computed(function(){if(e.plane.scheduledEquipment){var t=e.plane.scheduledEquipment;return"??"===t.name||null===t.name||void 0===t.name?t.iata:t.name}if(e.plane.actualEquipment){var r=e.plane.actualEquipment;return"??"===r.name||null===r.name||void 0===r.name?r.iata:r.name}}),t.searchables=ko.computed(function(){return e.searchables(t)}),t.inList=ko.computed(function(){return e.inList(t)})},flightControl=function(){var e,t=this,r="?appId=11381d70&appKey=59ee672f0e6a4744ca3a7efac46b4663";t.flightList=ko.observableArray([]),t.currFlight=ko.observable(),t.flightError=ko.observable(!1),t.photoView=ko.observable(!1),t.listVis=ko.observable(!0),t.searchVis=ko.observable(!1),t.searchBox=ko.observable(""),t.infoVis=ko.observable(!0),t.currFlightListed=ko.computed(function(){if(t.currFlight()){if(t.currFlight().inList())return!0;if(!t.currFlight().inList())return t.selFlight(null),!1}}),t.mapMonitor=ko.computed(function(){return t.flightList().forEach(function(t){return t.inList()?t.marker().getMap()===e||t.marker().setMap(e):t.inList()?void 0:null===t.marker().getMap()||t.marker().setMap(null)})}),t.searchWords=ko.computed(function(){return t.searchBox().split(" ")}),t.filteredList=ko.computed(function(){return t.flightList().filter(function(e){return e.inList()})}),t.results=ko.computed(function(){return 0===t.filteredList().length});var n=function(e,t,r){this.type=ko.observable(e),this.icon=ko.observable(t),this.title=ko.observable(r)};t.searchTypes=ko.observableArray([new n("flight","flight_takeoff","Search Plane Types"),new n("city","location_city","Search Cities"),new n("airline","flight","Search Flights and Airlines")]),t.searchCat=ko.observable(""),t.initialize=function(){var r={center:{lat:37.3894,lng:-122.0819},zoom:12,disableDefaultUI:!0};e=new google.maps.Map(document.getElementById("mapDiv"),r),mapBounds=new google.maps.LatLngBounds,flightListener=google.maps.event.addListener(e,"tilesloaded",t.loadFlights)},t.loadFlights=function(){google.maps.event.removeListener(flightListener);var i="https://api.flightstats.com/flex/flightstatus/rest/v2/jsonp/flightsNear/"+e.getCenter().lat()+"/"+e.getCenter().lng()+"/25"+r+"&maxFlights=10&extendedOptions=includeNewFields";$.ajax({dataType:"jsonp",url:i,success:function(e){return e.error?t.flightError(!0):void e.flightPositions.forEach(function(e){e.planeImg="",t.createFlights(e)})}})},t.createFlights=function(e){var i=e.flightId,n="https://api.flightstats.com/flex/flightstatus/rest/v2/jsonp/flight/status/"+i+r+"&extendedOptions=useInlinedReferences";$.ajax({dataType:"jsonp",url:n,success:function(r){var i=r.flightStatus;e.plane=i.flightEquipment,e.planeImg="http://planefinder.net/flightstat/v1/getImage.php?airlineCode="+i.carrier.icao+"&aircraftType="+(i.flightEquipment.scheduledEquipment||i.flightEquipment.actualEquipment).iata+"&skipFuzzy=0",e.airline=i.carrier.name,e.name="Flight "+i.flightNumber,e.depPort=i.departureAirport,e.arrPort=i.arrivalAirport,e.depTime=i.departureDate.dateLocal,e.arrTime=i.arrivalDate.dateLocal,e.tail=i.flightEquipment.tailNumber,e.carrier=i.carrier.icao,e.img="http://planefinder.net/flightstat/v1/getLogoRedirect.php?airlineCode="+e.carrier+"&requestThumb=0&isSSL=0",e.icon="http://planefinder.net/flightstat/v1/getLogoRedirect.php?airlineCode="+e.carrier+"&requestThumb=1&isSSL=0",e.marker=t.createMarker,e.posData=t.sortPos,e.searchables=t.flightTerms,e.inList=t.searchFlights;t.flightList.push(new Flight(e))},error:function(){e.plane="Plane type not available",e.depPort="Departure city not available",e.arrPort="Arrival city not available",e.img="http://planefinder.net/flightstat/v1/getLogoRedirect.php?airlineCode="+e.callsign.slice(3,0)+"&requestThumb=0&isSSL=0",e.icon="http://planefinder.net/flightstat/v1/getLogoRedirect.php?airlineCode="+e.callsign.slice(3,0)+"&requestThumb=1&isSSL=0",e.planeImg="",e.marker=t.createMarker,e.posData=t.sortPos,e.searchables=t.flightTerms,e.inList=t.searchFlights,t.flightList.push(new Flight(e))}})},t.sortPos=function(e){return sortDates=function(e,t){return Date.parse(e.date)-Date.parse(t.date)},e.sort(sortDates)},t.createMarker=function(r){var i=r.positions()[r.positions().length-1],n=new Image,a=new google.maps.Marker({map:null,title:r.callsign(),position:{lat:i.lat,lng:i.lon}});return n.onload=function(){a.setOptions({icon:r.icon(),map:e})},n.onerror=function(){a.setOptions({icon:{path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW,rotation:r.heading(),scale:4,strokeColor:"black"},map:e})},n.src=r.icon(),mapBounds.extend(a.position),e.fitBounds(mapBounds),google.maps.event.addListener(a,"click",function(){return t.selFlight(r,"marker")}),a},t.selFlight=function(e,r){if(null!==e&&"marker"!==r&&r.currentTarget.scrollIntoView(!0),t.currFlight()){window.clearInterval(flightTimer);var i=t.currFlight(),n=i.positions()[i.positions().length-1]}t.currFlight(e),i&&i.marker().setOptions({position:{lat:n.lat,lng:n.lon}}),t.currFlight()&&t.iconFly()},t.hideMenu=function(){t.listVis(!t.listVis())},t.iconFly=function(){var r=[],n=0,a=new google.maps.LatLngBounds;for(r=t.currFlight().positions(),i=0;i<r.length;i++){var o=new google.maps.LatLng(r[i].lat,r[i].lon);a.extend(o)}e.fitBounds(a),flightTimer=window.setInterval(function(){var e=r[n];t.currFlight().marker().setOptions({position:{lat:e.lat,lng:e.lon}}),n++,n>r.length-1&&(n=0)},300)},t.addFlight=function(e){window.setTimeout(function(){$(e).addClass("listed")},100)},t.removeFlight=function(e){$(e).removeClass("listed"),window.setTimeout(function(){$(e).remove()},1001)},t.hideImg=function(e){e.imgLoaded(!1)},t.planeImgError=function(e){e.planeLoaded(!1)},t.searchToggle=function(){t.searchVis(!t.searchVis())},t.infoToggle=function(){t.infoVis(!t.infoVis())},t.togglePhoto=function(){t.photoView(!t.photoView())},t.searchFlights=function(e){return t.searchWords().some(function(t){return-1!==e.searchables().toString().toLowerCase().search(t.toLowerCase())})},t.flightTerms=function(e){var r=[];if(t.searchCat()){switch(t.searchCat().type()){case"airline":return r=r.concat(e.flight(),e.airline());case"city":return r=r.concat(e.arriving(),e.departed());case"flight":return r=r.concat(e.plane())}return r=r.concat(e.flight(),e.arriving(),e.departed(),e.plane(),e.airline())}return r=r.concat(e.flight(),e.arriving(),e.departed(),e.plane(),e.airline())},t.searchCatToggle=function(e){t.searchCat(e===t.searchCat()?"":e)},google.maps.event.addDomListener(window,"load",t.initialize)};ko.applyBindings(new flightControl);